{% extends "base.html" %}

{% block title %}{{ categories[current_category - 1].name if categories else 'èª¿å‘³æ–™' }}ä¸€è¦§ - å†·è”µåº«ç®¡ç†ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="items-page">
    <header class="page-header">
        <h1>å†·è”µåº«ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
        <div style="display: flex; gap: 10px;">
            <a href="{{ url_for('shopping_list') }}" class="btn btn-icon">ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ</a>
            <a href="{{ url_for('share_settings') }}" class="btn btn-icon">âš™ï¸ å…±æœ‰è¨­å®š</a>
        </div>
    </header>
    
    <div class="toolbar">
        <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
        <div class="category-selector">
            <select id="categorySelect" class="category-dropdown" onchange="changeCategory(this.value)">
                {% for category in categories %}
                <option value="{{ category.id }}" {% if category.id == current_category %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
            <button class="btn btn-small" onclick="showCategoryModal()">+ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
        </div>
        
        <!-- ã‚½ãƒ¼ãƒˆãƒˆã‚°ãƒ« & è©³ç´°éè¡¨ç¤º -->
        <div class="toolbar-right">
            <div class="toggle-buttons">
                <button class="toggle-btn {% if current_sort == 'expiry' %}active{% endif %}" 
                        onclick="window.location.href='{{ url_for('items_list', category=current_category, sort='expiry') }}'">
                    æœŸé™é †
                </button>
                <button class="toggle-btn {% if current_sort == 'quantity' %}active{% endif %}"
                        onclick="window.location.href='{{ url_for('items_list', category=current_category, sort='quantity') }}'">
                    æ®‹é‡é †
                </button>
            </div>
            <button class="btn btn-small" id="toggleDetailBtn" onclick="toggleDetail()">
                è©³ç´°ã‚’éè¡¨ç¤º
            </button>
        </div>
    </div>
    
    <div class="items-list" id="itemsList">
        {% if items %}
            {% for item in items %}
            <div class="item-card">
                <div class="item-header">
                    <h3>{{ item.name }} <span class="container-type">({{ item.container_type_text }})</span></h3>
                </div>
                
                <div class="item-details">
                    {% if item.opened_date %}
                    <p class="item-dates">
                        <span class="date-label">é–‹å°:</span> {{ item.opened_date }}
                        <span class="date-separator">|</span>
                        <span class="days-since-open {{ item.days_since_open_class }}">
                            é–‹å°ã‹ã‚‰{{ item.days_since_open }}æ—¥çµŒé
                        </span>
                    </p>
                    {% endif %}
                    <p class="expiry-date {{ item.expiry_class }}">
                        è³å‘³æœŸé™: 
                        {% if item.expiry_date %}
                            {{ item.expiry_date }}
                            {% if item.expiry_icon %}
                                <span class="icon">{{ item.expiry_icon }}</span>
                            {% endif %}
                        {% else %}
                            æœªè¨­å®š
                        {% endif %}
                    </p>
                    {% if item.memo %}
                    <p class="item-memo">
                        <span class="memo-icon">ğŸ“</span> {{ item.memo }}
                    </p>
                    {% endif %}
                </div>
                
                <div class="quantity-selector item-details">
                    <span>æ®‹é‡:</span>
                    <form method="POST" action="{{ url_for('update_quantity', item_id=item.id, new_level=1) }}" style="display: inline;">
                        <button type="submit" class="qty-btn {% if item.quantity_level == 1 %}active level-1{% endif %}">æº€</button>
                    </form>
                    <form method="POST" action="{{ url_for('update_quantity', item_id=item.id, new_level=2) }}" style="display: inline;">
                        <button type="submit" class="qty-btn {% if item.quantity_level == 2 %}active level-2{% endif %}">åŠ</button>
                    </form>
                    <form method="POST" action="{{ url_for('update_quantity', item_id=item.id, new_level=3) }}" style="display: inline;">
                        <button type="submit" class="qty-btn {% if item.quantity_level == 3 %}active level-3{% endif %}">å°‘</button>
                    </form>
                    <form method="POST" action="{{ url_for('update_quantity', item_id=item.id, new_level=4) }}" style="display: inline;">
                        <button type="submit" class="qty-btn {% if item.quantity_level == 4 %}active level-4{% endif %}">ç„¡</button>
                    </form>
                </div>
                
                <div class="item-actions">
                    {% if item.show_add_to_list %}
                    <form method="POST" action="{{ url_for('add_to_shopping_list', item_id=item.id) }}" style="display: inline;" onsubmit="return confirm('è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ');">
                        <button type="submit" class="btn btn-small btn-list">ğŸ›’ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
                    </form>
                    {% endif %}
                    <a href="{{ url_for('edit', item_id=item.id) }}" class="btn btn-small">ç·¨é›†</a>
                    <form method="POST" action="{{ url_for('delete_item', item_id=item.id) }}" style="display: inline;" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹?');">
                        <button type="submit" class="btn btn-small btn-danger">å‰Šé™¤</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="no-items">ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>

    <!-- æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
    <a href="{{ url_for('register', category=current_category) }}" class="fab">
        <span class="fab-icon">+</span>
    </a>

</div>

<!-- ã‚«ãƒ†ã‚´ãƒªæ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <h2>ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </h2>
        <form method="POST" action="{{ url_for('add_category') }}">
            <div class="form-group">
                <label for="categoryName">ã‚«ãƒ†ã‚´ãƒªå</label>
                <input type="text" id="categoryName" name="name" required maxlength="50" placeholder="ä¾‹: é£²æ–™ã€ãŠè“å­">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="btn btn-primary">è¿½åŠ </button>
            </div>
        </form>
    </div>
</div>
<div id="modalBackdrop" class="modal-backdrop" onclick="closeCategoryModal()"></div>

{% endblock %}

{% block scripts %}
<script>
// ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´
function changeCategory(categoryId) {
    window.location.href = '{{ url_for("items_list") }}?category=' + categoryId + '&sort={{ current_sort }}';
}

// ã‚«ãƒ†ã‚´ãƒªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showCategoryModal() {
    document.getElementById('categoryModal').style.display = 'block';
    document.getElementById('modalBackdrop').style.display = 'block';
}

// ã‚«ãƒ†ã‚´ãƒªãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
function closeCategoryModal() {
    document.getElementById('categoryModal').style.display = 'none';
    document.getElementById('modalBackdrop').style.display = 'none';
}

// è©³ç´°è¡¨ç¤º/éè¡¨ç¤ºãƒˆã‚°ãƒ«
function toggleDetail() {
    const details = document.querySelectorAll('.item-details');
    const btn = document.getElementById('toggleDetailBtn');
    const isHidden = localStorage.getItem('hideDetails') === 'true';
    
    if (isHidden) {
        // è¡¨ç¤ºã™ã‚‹
        details.forEach(el => el.style.display = '');
        btn.textContent = 'è©³ç´°ã‚’éè¡¨ç¤º';
        btn.classList.remove('active');
        localStorage.setItem('hideDetails', 'false');
    } else {
        // éè¡¨ç¤ºã«ã™ã‚‹
        details.forEach(el => el.style.display = 'none');
        btn.textContent = 'è©³ç´°ã‚’è¡¨ç¤º';
        btn.classList.add('active');
        localStorage.setItem('hideDetails', 'true');
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«çŠ¶æ…‹ã‚’å¾©å…ƒ
window.addEventListener('DOMContentLoaded', () => {
    const isHidden = localStorage.getItem('hideDetails') === 'true';
    if (isHidden) {
        const details = document.querySelectorAll('.item-details');
        const btn = document.getElementById('toggleDetailBtn');
        details.forEach(el => el.style.display = 'none');
        btn.textContent = 'è©³ç´°ã‚’è¡¨ç¤º';
        btn.classList.add('active');
    }
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
    const scrollPos = sessionStorage.getItem('scrollPos');
    if (scrollPos) {
        window.scrollTo(0, parseInt(scrollPos));
        sessionStorage.removeItem('scrollPos');
    }
});

// æ®‹é‡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        sessionStorage.setItem('scrollPos', window.scrollY);
    });
});
</script>
{% endblock %}